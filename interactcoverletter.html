<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dyse - Cover Letter Builder</title>
    <meta name="description" content="Craft a professional, ATS-optimized cover letter for free. Save, share, and download your letters.">
    <meta name="author" content="Vishal Kondabathini">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&family=Inter:wght@400;500;700;800&family=Lato&family=Roboto&family=Merriweather&family=Lora&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .header-font { font-family: 'Poppins', sans-serif; }
        .tab-button.active { @apply border-indigo-500 text-indigo-600; }
        .tab-button { @apply whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300; }
        .action-btn { @apply inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white transition focus:outline-none focus:ring-2 focus:ring-offset-2; }
        .add-btn { @apply bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500; }
        .remove-btn { @apply bg-red-600 hover:bg-red-700 focus:ring-red-500; }
        .guidance { @apply text-sm text-gray-500 italic bg-gray-100 p-3 rounded-lg border-l-4 border-indigo-400; }
        .styled-textarea { @apply transition-shadow focus:shadow-lg focus:bg-blue-50/50 resize-none overflow-hidden w-full px-4 py-3 rounded-xl font-semibold text-gray-800 border-2 border-indigo-200 focus:border-blue-500; }
        .input-field { @apply w-full px-4 py-3 border border-gray-300 bg-white shadow-sm rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-base focus:bg-indigo-50; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="p-4 md:p-8">

    <nav class="fixed top-0 left-0 right-0 bg-white shadow-md z-50">
        <div class="container mx-auto px-4 max-w-7xl">
            <div class="flex justify-between items-center py-3">
                <a href="/interactcvgenerator.html" class="flex items-center space-x-2 text-gray-500 hover:text-indigo-600 transition-colors">
                    <img src="/assets/favicon.ico" alt="Dyse home" class="h-6 w-6">
                    <span class="font-semibold text-lg header-font">Dyse</span>
                </a>
                <div class="flex items-center space-x-4" id="auth-container"></div>
            </div>
        </div>
    </nav>

    <div id="main-content" class="pt-16">
        <div id="loading-screen" class="flex items-center justify-center h-64">
            <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-indigo-500"></div>
        </div>
        <div id="builder-wrapper" class="w-full max-w-7xl mx-auto hidden">
             <div class="w-full bg-white rounded-2xl shadow-2xl p-8">
                 <div>
                     <div class="border-b border-gray-200">
                         <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                             <button id="tab-builder" class="tab-button active">Builder</button>
                             <button id="tab-preview" class="tab-button">Live Preview</button>
                         </nav>
                     </div>
                 </div>
                 <div id="tab-panels" class="mt-8">
                     <div id="panel-builder"></div>
                     <div id="panel-preview" class="hidden"></div>
                 </div>
             </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full relative max-h-[90vh] overflow-y-auto">
             <button id="close-profile-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button>
             <h2 class="text-3xl font-bold text-center mb-6 text-gray-800 header-font">My Documents</h2>
             <div class="text-center mb-4"><button id="create-new-btn" class="action-btn add-btn text-sm"><i class="fas fa-plus mr-2"></i>Create New Letter</button></div>
             <div id="saved-documents-container" class="space-y-4"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="/assets/js/firebase-config.js"></script>
    <script>
    // Cover Letter App Logic
    document.addEventListener('DOMContentLoaded', () => {
        if (!window.firebaseConfig) {
            document.body.innerHTML = '<p class="text-red-500 text-center p-8">Firebase configuration is missing.</p>';
            return;
        }
        firebase.initializeApp(window.firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('builder-wrapper').classList.remove('hidden');
                setupUserProfile(user);
                
                if (!document.getElementById('panel-builder').innerHTML.trim()) { 
                    setupUI();
                    initializeGeneratorLogic(); 
                }
                loadUserDocuments();
            } else {
                window.location.href = '/index.html';
            }
        });

        function setupUserProfile(user) {
            const authContainer = document.getElementById('auth-container');
            authContainer.innerHTML = `
                <a href="/interactcvgenerator.html" class="action-btn bg-purple-600 hover:bg-purple-700 focus:ring-purple-500 text-sm">Build a CV</a>
                <div class="relative">
                    <button id="profile-btn" class="flex items-center space-x-3 text-gray-700">
                        <img src="${user.photoURL}" alt="${user.displayName}" class="w-10 h-10 rounded-full border-2 border-gray-200 hover:border-indigo-500 transition">
                        <span class="font-semibold text-sm hidden md:block">${user.displayName}</span>
                    </button>
                </div>`;

            const profileBtn = document.getElementById('profile-btn');
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('profile-modal').classList.remove('hidden');
                document.getElementById('profile-modal').classList.add('flex');
            });
            
            document.getElementById('close-profile-modal-btn').addEventListener('click', () => {
                document.getElementById('profile-modal').classList.add('hidden');
            });

            document.getElementById('create-new-btn').addEventListener('click', () => {
                if (confirm('Create a new blank cover letter? Any unsaved changes will be lost.')) {
                    initializeGeneratorLogic();
                    document.getElementById('profile-modal').classList.add('hidden');
                }
            });
        }

        function setupUI() {
            document.getElementById('panel-builder').innerHTML = `
                <div id="builder-content">
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <span class="text-base font-medium text-gray-700" id="progress-label">Cover Letter Progress</span>
                                <span id="progress-percent" class="text-sm font-medium text-gray-700 ml-2">0%</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="card-container" class="relative" style="min-height: 480px;"></div>
                </div>
                <div class="flex justify-between mt-8 items-center">
                    <button id="prev-btn" class="transition text-5xl text-gray-400 hover:text-gray-600"><i class="fas fa-arrow-left"></i></button>
                    <button id="next-btn" class="transition text-5xl"><i class="fas fa-arrow-right"></i></button>
                </div>`;
            document.getElementById('panel-preview').innerHTML = `
                <div id="preview-section">
                    <h3 class="text-center font-bold text-gray-500 mb-4 uppercase tracking-wider" id="preview-title">Live Preview</h3>
                    <div id="preview-area" class="bg-white p-8 rounded-lg border border-gray-200 shadow-inner h-[80vh] overflow-y-auto text-sm"></div>
                    <div class="text-center mt-6">
                        <button id="download-doc-btn" class="action-btn add-btn text-base opacity-50 cursor-not-allowed" disabled>
                            <i class="fas fa-file-word mr-2"></i> Download as Word
                        </button>
                    </div>
                </div>`;
        }

        function initializeGeneratorLogic(dataToLoad = null) {
            const cardContainer = document.getElementById('card-container');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');
            const previewArea = document.getElementById('preview-area');
            const downloadDocBtn = document.getElementById('download-doc-btn');
            const tabBuilder = document.getElementById('tab-builder');
            const tabPreview = document.getElementById('tab-preview');
            const panels = [document.getElementById('panel-builder'), document.getElementById('panel-preview')];
            const tabs = [tabBuilder, tabPreview];
            
            let currentStep = 0;
            window.coverLetterData = dataToLoad || {
                yourInfo: { name: currentUser.displayName || '', address: '', phone: '', email: currentUser.email || '', linkedin: '' },
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                companyInfo: { managerName: '', managerTitle: '', companyName: '', companyAddress: '' },
                opening: '',
                bodyParagraphs: [''],
                companyConnection: '',
                closing: '',
                font: 'Inter',
                docId: null
            };

            const steps = [                
                { title: 'Your Information', icon: 'fa-user-tie', color: 'indigo' },
                { title: 'Company Information', icon: 'fa-building', color: 'sky' },
                { title: 'The Opening', icon: 'fa-door-open', color: 'emerald' },
                { title: 'Your Value Proposition', icon: 'fa-briefcase', color: 'amber' },
                { title: 'Your Interest in the Company', icon: 'fa-heart', color: 'rose' },
                { title: 'Closing Paragraph', icon: 'fa-pen-fancy', color: 'fuchsia' }
            ];

            tabs.forEach((tab, index) => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active', 'border-indigo-500', 'text-indigo-600'));
                    panels.forEach(p => p.classList.add('hidden'));
                    tab.classList.add('active', 'border-indigo-500', 'text-indigo-600');
                    panels[index].classList.remove('hidden');
                    if (panels[index].id === 'panel-preview') updatePreview();
                });
            });

            function navigate(direction) {
                saveStepData(currentStep);
                if (direction === 'next' && currentStep === steps.length - 1) {
                    if(validateStep(currentStep)) tabPreview.click();
                    return;
                }
                let nextStep = currentStep;
                if (direction === 'next' && currentStep < steps.length - 1) nextStep++;
                else if (direction === 'prev' && currentStep > 0) nextStep--;
                
                if (nextStep !== currentStep) {
                    currentStep = nextStep;
                    renderStep(currentStep);
                }
            }
            
            function updateNavButtons() {
                prevBtn.style.visibility = currentStep === 0 ? 'hidden' : 'visible';
                const isValid = validateStep(currentStep);
                nextBtn.disabled = !isValid;
                nextBtn.className = 'transition'; 

                if (currentStep === steps.length - 1) {
                    nextBtn.innerHTML = 'Preview & Download <i class="fas fa-eye ml-2"></i>';
                    nextBtn.classList.add('action-btn', 'add-btn', 'text-base');
                    if (!isValid) nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
                    nextBtn.classList.add('text-5xl');
                    if(isValid) nextBtn.classList.add('text-indigo-500', 'hover:text-indigo-700');
                    else nextBtn.classList.add('text-gray-300', 'cursor-not-allowed');
                }
                downloadDocBtn.disabled = !validateAllSteps();
                downloadDocBtn.classList.toggle('opacity-50', !validateAllSteps());
                downloadDocBtn.classList.toggle('cursor-not-allowed', !validateAllSteps());
            }

            function renderStep(stepIndex) {
                const step = steps[stepIndex];
                cardContainer.innerHTML = `<div id="card-${stepIndex}" class="card p-4 space-y-4"></div>`;
                const card = document.getElementById(`card-${stepIndex}`);
                const color = step.color;
                card.innerHTML = `<div class="bg-gradient-to-tr from-${color}-500/20 to-${color}-400/10 rounded-3xl shadow-2xl p-8 transition-all duration-500"><div class="text-center mb-8"><i class="fas ${step.icon} text-7xl text-${color}-400 mb-4"></i><h2 class="text-4xl font-extrabold text-${color}-700 mb-2 tracking-tight header-font">${step.title}</h2></div><div class="form-content space-y-6"></div></div>`;
                const formContent = card.querySelector('.form-content');
                
                switch(step.title) {
                    case 'Your Information':
                        formContent.innerHTML = `<p class="guidance">Let's start with your contact details and choose a font for your letter.</p><div class="relative group mb-4 grid grid-cols-1 sm:grid-cols-3 gap-x-4 items-center"><label for="font-select" class="font-semibold text-gray-600 mb-1 sm:mb-0 sm:text-right flex items-center sm:justify-end"><i class="fas fa-font w-5 mr-2 text-${color}-400"></i>Choose a Font</label><div class="sm:col-span-2"><select id="font-select" class="input-field"><option value="Inter">Inter (Modern)</option><option value="Poppins">Poppins (Stylish)</option><option value="Roboto">Roboto (Classic)</option><option value="Merriweather">Merriweather (Serif)</option></select></div></div>
                        ${createInput('yourName', 'fa-user', 'Full Name', window.coverLetterData.yourInfo.name, color, { isRequired: true })}
                        ${createInput('yourAddress', 'fa-map-marker-alt', 'Full Address', window.coverLetterData.yourInfo.address, color, { isTextarea: true })}
                        ${createInput('yourPhone', 'fa-phone', 'Phone Number', window.coverLetterData.yourInfo.phone, color)}
                        ${createInput('yourEmail', 'fa-envelope', 'Email Address', window.coverLetterData.yourInfo.email, color, {isRequired: true})}
                        ${createInput('yourLinkedin', 'fa-linkedin', 'LinkedIn Profile URL', window.coverLetterData.yourInfo.linkedin, color)}`;
                        break;
                    case 'Company Information':
                        formContent.innerHTML = `<p class="guidance">Address the letter to a specific person if possible. 'Hiring Manager' is a safe default.</p>
                        ${createInput('managerName', 'fa-user-tie', "Hiring Manager's Name", window.coverLetterData.companyInfo.managerName, color)}
                        ${createInput('managerTitle', 'fa-id-badge', "Hiring Manager's Title", window.coverLetterData.companyInfo.managerTitle, color)}
                        ${createInput('companyName', 'fa-building', 'Company Name', window.coverLetterData.companyInfo.companyName, color, { isRequired: true })}
                        ${createInput('companyAddress', 'fa-globe', "Company's Full Address", window.coverLetterData.companyInfo.companyAddress, color, { isTextarea: true })}`;
                        break;
                    case 'The Opening': renderTextareaStep(formContent, 'opening', "Example: I am writing to express my enthusiastic interest...", "Start strong! State the position and where you saw it.", window.coverLetterData.opening, color); break;
                    case 'Your Value Proposition':
                        formContent.innerHTML = `<p class="guidance">This is the core. Connect your skills to the job requirements with specific examples.</p><div id="body-paragraphs-container" class="space-y-4">${renderBodyParagraphs(color)}</div><button id="add-paragraph-btn" class="text-indigo-600 hover:text-indigo-800 font-semibold text-sm mt-2">+ Add paragraph</button>`;
                        break;
                    case 'Your Interest in the Company': renderTextareaStep(formContent, 'companyConnection', "Example: I am particularly drawn to [Company Name]'s commitment to...", "Show you've done your homework. Why this company?", window.coverLetterData.companyConnection, color); break;
                    case 'Closing Paragraph': renderTextareaStep(formContent, 'closing', "Example: With my proven track record... I am confident I can contribute...", "End with confidence. Reiterate your key qualification and excitement.", window.coverLetterData.closing, color); break;
                }
                
                card.querySelectorAll('input, textarea, select').forEach(el => el.addEventListener('input', handleInput));
                if (step.title === 'Your Value Proposition') {
                    document.getElementById('add-paragraph-btn').addEventListener('click', () => {
                        saveStepData(currentStep);
                        window.coverLetterData.bodyParagraphs.push('');
                        renderStep(currentStep);
                    });
                }
                updateProgressBar();
                updateNavButtons();
                updatePreview();
            }

            function renderTextareaStep(formContent, id, placeholder, guidance, value, color) { /* ... implementation ... */ }
            function createInput(id, icon, placeholder, value, color, options = {}) { /* ... implementation ... */ }
            function renderBodyParagraphs(color) { /* ... implementation ... */ }
            function saveStepData(stepIndex) { /* ... implementation ... */ }
            function validateStep(stepIndex) { /* ... implementation ... */ }
            function validateAllSteps() { return steps.every((_, i) => validateStep(i)); }
            function updatePreview() { /* ... implementation ... */ }
            function updateProgressBar() { /* ... implementation ... */ }

            // ... Full implementations of helper functions from "Actual Code"
            function renderTextareaStep(formContent, id, placeholder, guidance, value, color) {
                const minChars = 30;
                formContent.innerHTML = `<p class="guidance">${guidance}</p><textarea id="${id}" class="input-field" rows="8" placeholder="${placeholder}">${value}</textarea><div class="text-right text-xs text-gray-500"><span id="char-count">${value.trim().length}</span> / ${minChars} min characters</div>`;
                const textarea = formContent.querySelector('textarea');
                textarea.addEventListener('input', () => {
                    document.querySelector('#char-count').textContent = textarea.value.trim().length;
                    handleInput();
                });
            }
            function createInput(id, icon, placeholder, value, color, options = {}) {
                const { isTextarea = false, isRequired = false } = options;
                const inputEl = isTextarea ? `<textarea id="${id}" rows="1" class="input-field" placeholder="${placeholder}" oninput="autoResize(this)">${value}</textarea>` : `<input id="${id}" class="input-field" placeholder="${placeholder}" value="${value}">`;
                return `<div class="space-y-1"><label for="${id}" class="block text-sm font-medium text-gray-700"><i class="fas ${icon} text-${color}-500 w-5 mr-2"></i>${placeholder}${isRequired ? '<span class="text-red-500">*</span>' : ''}</label>${inputEl}</div>`;
            }
            function renderBodyParagraphs(color) {
                return window.coverLetterData.bodyParagraphs.map((p, i) => `<div class="relative"><textarea class="body-paragraph input-field" rows="5" placeholder="Paragraph ${i + 1}...">${p}</textarea>${window.coverLetterData.bodyParagraphs.length > 1 ? `<button class="absolute top-2 right-2 text-red-500 hover:text-red-700 font-bold" onclick="removeParagraph(${i})">&times;</button>` : ''}</div>`).join('');
            }
            window.removeParagraph = (index) => { saveStepData(currentStep); window.coverLetterData.bodyParagraphs.splice(index, 1); renderStep(currentStep); };
            
            function saveStepData(stepIndex) {
                const card = document.querySelector(`#card-${stepIndex}`);
                if (!card) return;
                switch(steps[stepIndex].title) {
                    case 'Your Information': Object.keys(window.coverLetterData.yourInfo).forEach(key => { window.coverLetterData.yourInfo[key] = card.querySelector(`#${'your' + key.charAt(0).toUpperCase() + key.slice(1)}`).value; }); window.coverLetterData.font = card.querySelector('#font-select').value; break;
                    case 'Company Information': Object.keys(window.coverLetterData.companyInfo).forEach(key => { window.coverLetterData.companyInfo[key] = card.querySelector(`#${key}`).value; }); break;
                    case 'The Opening': window.coverLetterData.opening = card.querySelector('#opening').value; break;
                    case 'Your Value Proposition': window.coverLetterData.bodyParagraphs = Array.from(card.querySelectorAll('.body-paragraph')).map(textarea => textarea.value); break;
                    case 'Your Interest in the Company': window.coverLetterData.companyConnection = card.querySelector('#companyConnection').value; break;
                    case 'Closing Paragraph': window.coverLetterData.closing = card.querySelector('#closing').value; break;
                }
            }

            function validateStep(stepIndex) {
                saveStepData(stepIndex); // ensure data is current
                const data = window.coverLetterData;
                const minChars = 30;
                switch(steps[stepIndex].title) {
                    case 'Your Information': return data.yourInfo.name.trim() !== '' && data.yourInfo.email.trim() !== '';
                    case 'Company Information': return data.companyInfo.companyName.trim() !== '';
                    case 'The Opening': return data.opening.trim().length >= minChars;
                    case 'Your Value Proposition': return data.bodyParagraphs.length > 0 && data.bodyParagraphs.some(p => p.trim().length >= minChars);
                    case 'Your Interest in the Company': return data.companyConnection.trim().length >= minChars;
                    case 'Closing Paragraph': return data.closing.trim().length >= minChars;
                    default: return true;
                }
            }
             function updatePreview() {
                previewArea.style.fontFamily = `'${window.coverLetterData.font}', sans-serif`;
                let d = window.coverLetterData;
                previewArea.innerHTML = `<div class="text-right mb-8"><p class="font-bold text-lg">${d.yourInfo.name}</p><p>${d.yourInfo.address}</p><p>${d.yourInfo.phone}${d.yourInfo.email ? ` | ${d.yourInfo.email}`:''}</p><p>${d.yourInfo.linkedin}</p></div><div class="mb-8"><p>${d.date}</p></div><div class="mb-8"><p>${d.companyInfo.managerName||'Hiring Manager'}</p><p>${d.companyInfo.managerTitle}</p><p class="font-bold">${d.companyInfo.companyName}</p><p>${d.companyInfo.companyAddress}</p></div><div class="mb-4"><p><strong>Dear ${d.companyInfo.managerName || 'Hiring Manager'},</strong></p></div><div class="space-y-4 leading-relaxed"><p>${d.opening}</p>${d.bodyParagraphs.map(p => `<p>${p}</p>`).join('')}<p>${d.companyConnection}</p><p>${d.closing}</p></div><div class="mt-8"><p>Sincerely,</p><p class="mt-4">${d.yourInfo.name}</p></div>`;
            }

            function updateProgressBar() {
                const percentage = (currentStep / (steps.length - 1)) * 100;
                progressBar.style.width = `${percentage}%`;
                progressPercent.textContent = `${Math.round(percentage)}%`;
            }
            
            window.autoResize = (el) => { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; };
            window.handleInput = () => { saveStepData(currentStep); updatePreview(); updateNavButtons(); };
            
            downloadDocBtn.addEventListener('click', () => { /* ... generateAndDownloadDocx logic ... */ });
            
            // Initial render
            prevBtn.addEventListener('click', () => navigate('prev'));
            nextBtn.addEventListener('click', () => navigate('next'));
            renderStep(0);
        }
        
        async function saveDocument(docName) {
            if (!currentUser) return alert("You must be logged in to save.");
            const btn = document.querySelector('#download-doc-btn'); // Or a dedicated save button
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...'; }
            
            try {
                const dataToSave = JSON.parse(JSON.stringify(window.coverLetterData));
                const docId = dataToSave.docId;
                delete dataToSave.docId;

                const docData = {
                    name: docName,
                    type: 'Cover Letter',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    letterData: dataToSave,
                };

                if (docId) {
                    await db.collection('users').doc(currentUser.uid).collection('documents').doc(docId).set(docData, { merge: true });
                } else {
                    docData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    const docRef = await db.collection('users').doc(currentUser.uid).collection('documents').add(docData);
                    window.coverLetterData.docId = docRef.id;
                }
                alert(`'${docName}' saved successfully!`);
                loadUserDocuments();
            } catch (error) {
                console.error("Error saving document: ", error);
                alert(`Error saving: ${error.message}`);
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-file-word mr-2"></i> Download as Word'; }
            }
        }
        
        async function loadUserDocuments() {
            if (!currentUser) return;
            const container = document.getElementById('saved-documents-container');
            container.innerHTML = '<p class="text-center py-4">Loading documents...</p>';
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('documents').orderBy('updatedAt', 'desc').get();
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">No documents saved yet.</p>';
                return;
            }
            
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const docData = doc.data();
                const docEl = document.createElement('div');
                docEl.className = 'bg-gray-50 p-4 rounded-lg flex items-center justify-between gap-4 border-l-4';
                
                let contentHTML = `<div class="flex-grow"><p class="font-bold text-gray-800">${docData.name}</p><p class="text-xs text-gray-500">Type: ${docData.type}</p><p class="text-xs text-gray-500">Last updated: ${docData.updatedAt ? docData.updatedAt.toDate().toLocaleString() : 'N/A'}</p></div>`;
                
                if (docData.type === 'Cover Letter') {
                    docEl.classList.add('border-purple-300');
                    contentHTML += `<div class="flex items-center space-x-2 flex-shrink-0"><button class="action-btn bg-blue-500 hover:bg-blue-600 load-letter-btn" data-doc-id="${doc.id}">Load</button><button class="action-btn remove-btn delete-btn" data-doc-id="${doc.id}">Delete</button></div>`;
                } else {
                    // Handle CVs or other types - for now, just show info
                    docEl.classList.add('border-indigo-300');
                    contentHTML += `<div><a href="/interactcvgenerator.html" class="action-btn add-btn">Edit CV</a></div>`;
                }

                docEl.innerHTML = contentHTML;
                container.appendChild(docEl);
            });

            container.querySelectorAll('.load-letter-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const docId = e.currentTarget.dataset.docId;
                const docRef = db.collection('users').doc(currentUser.uid).collection('documents').doc(docId);
                const doc = await docRef.get();
                if (doc.exists) {
                    const loadedData = doc.data().letterData;
                    loadedData.docId = doc.id;
                    initializeGeneratorLogic(loadedData);
                    alert('Cover Letter loaded!');
                    document.getElementById('profile-modal').classList.add('hidden');
                }
            }));
            
            container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const docId = e.currentTarget.dataset.docId;
                if (confirm('Are you sure you want to delete this document?')) {
                    await db.collection('users').doc(currentUser.uid).collection('documents').doc(docId).delete();
                    loadUserDocuments();
                }
            }));
        }
    });
    </script>
</body>
</html>
